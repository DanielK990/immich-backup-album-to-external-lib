<!DOCTYPE html>
<html>
    <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
        <title>Backup Immich Album to External Library</title>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
              rel="stylesheet">
        <style>
        body {
            background: #18181b;
            color: #f4f4f5;
            font-family: 'Inter', Arial, sans-serif;
            margin: 0;
            min-height: 100vh;
        }
        .custom-container {
            max-width: 480px;
            margin: 40px auto 0 auto;
            background: #fff;
            color: #232336;
            border-radius: 18px;
            box-shadow: 0 4px 32px 0 #0002;
            padding: 32px 16px 24px 16px;
        }
        .custom-container > * {
            max-width: 100%;
            box-sizing: border-box;
        }        
        .custom-container label,
        .custom-container h2,
        .custom-container .form-check-label,
        .custom-container .form-select,
        .custom-container .form-control {
            color: #232336 !important;
        }
        .custom-container .form-select,
        .custom-container .form-control {
            background-color: #f4f4f5 !important;
        }
        .custom-container .btn-primary {
            color: #fff !important;
        }
        @media (max-width: 576px) {
            .custom-container {
                max-width: 100vw;
                margin: 0;
                border-radius: 0;
                padding: 18px 2vw 18px 2vw;
            }
        }
        #back {
            display: none;
            margin-top: 18px;
            text-align: center;
        }
        #back a {
            color: #fbbf24;
            font-weight: 600;
            text-decoration: underline;
            font-size: 1.08em;
            transition: color 0.2s;
        }
        #back a:hover {
            color: #fde68a;
        }
        #back a:visited {
            background: #000000ff;
        }
        .error-box, .error-box-static {
            background: #920808ff;
            color: #ffffffff;
            border: 1.5px solid #232336;
            font-family: 'Fira Mono', 'Consolas', 'Menlo', 'Monaco', 'Liberation Mono', monospace;
            font-size: 1.01em;
            padding: 14px 16px;
            border-radius: 8px;
            font-weight: 400;
            white-space: pre-line;
            box-shadow: 0 2px 12px 0 #0003;
            letter-spacing: 0.01em;
            display: none;
        }

        .error-box-static {
            display: block;
        }

        .success-box {
            border: 1.5px solid #232336;
            background: #0b710b;
            color: #ffffffff;
            font-family: 'Fira Mono', 'Consolas', 'Menlo', 'Monaco', 'Liberation Mono', monospace;
            font-size: 1.01em;
            padding: 14px 16px;
            border-radius: 8px;
            font-weight: 400;
            white-space: pre-line;
            box-shadow: 0 2px 12px 0 #0003;
            letter-spacing: 0.01em;
            display: none;
        }
        #progress-label, #current-label {
            display: block;
            text-align: center;
            width: 100%;
            font-size: 1.08em;
        }
        #copy-progress {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            display: block;
        }
        #copy-errors, #success, #back {
            width: 100%;
        }
        input[type="checkbox"] {
            accent-color: #6366f1;
            width: 18px;
            height: 18px;
            vertical-align: middle;
        }
        .select2-dropdown,
        .select2-results__option {
            color: #232336 !important;
        }
        .select2-results__option--highlighted {
            background: #6366f1 !important;
            color: #fff !important;
        }        
        </style>
        <script>
        // Polling for copy progress
        async function pollProgress(jobId) {
            if (!jobId) return;
            const bar = document.getElementById('copy-progress');
            const progressLabel = document.getElementById('progress-label');
            const currentLabel = document.getElementById('current-label');
            const errorsBox = document.getElementById('copy-errors');
            const successBox = document.getElementById('success');

            const timer = setInterval(async () => {
                try {
                    const res = await fetch(`/progress/${jobId}`);
                    if (!res.ok) return; // keep trying
                    const data = await res.json();
                    const pct = data.percent || 0;
                    const current = data.current || "";
                    bar.value = pct;
                    progressLabel.textContent = pct + '%';
                    currentLabel.textContent = current;

                    if (Array.isArray(data.errors) && data.errors.length) {
                        errorsBox.style.display = 'block';
                        errorsBox.innerHTML = data.errors.map(e => `<div>${e}</div>`).join('');
                    }

                    if (data.complete) {
                        clearInterval(timer);
                        if (!Array.isArray(data.errors) || data.errors.length == 0) {
                            successBox.style.display = 'block';
                        }
                        back.style.display = 'block';
                    }
                } catch (e) { /* ignore transient errors */ }
            }, 800);
        }
        window.addEventListener('load', () => {
            const jobId = document.body.getAttribute('data-job');
            if (jobId) pollProgress(jobId);
        });

        $(document).ready(function() {
            $('.basic-single-select').select2();
        });
        
        </script>
    </head>
    <body data-job="{{ job_id or '' }}">
    <div class="custom-container shadow-lg bg-body rounded">
            <h2 class="text-center fw-bold mb-4" style="color:#fff;">Immich Backup Albums to External Library</h2>
            {% if error %}<div class="error-box-static">{{ error | nl2br | safe }}</div>{% endif %}
            {% if albums %}
                <form method="post" action="/submit">
                    <div class="mb-3">
                        <label for="album_name" class="form-label">Album:</label>
                        <select class="form-select basic-single-select" name="album_id" id="album_name" required>
                            <option value="" disabled {% if not selected_album %}selected{% endif %}>Select an album</option>
                            {% for album in albums %}
                                <option value="{{ album[1] }}" {% if selected_album == album[0] %}selected{% endif %}>{{ album[0] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="path" class="form-label">External Path:</label>
                        <select class="form-select basic-single-select" name="path" id="path" required>
                            <option value="" disabled {% if not selected_path %}selected{% endif %}>Select a path</option>
                            {% for path in paths %}
                                <option value="{{ path }}"  {% if selected_path == path %}selected{% endif %}>{{ path }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" name="create_subdir_for_year" id="create_subdir_for_year" {% if create_subdir_for_year %}checked{% endif %}>
                        <label class="form-check-label" for="create_subdir_for_year">Create Subdirectory for each Year</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" name="delete_assets" id="delete_assets" {% if delete_assets %}checked{% endif %}>
                        <label class="form-check-label" for="delete_assets">Delete Assets in Album</label>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="delete_album" id="delete_album" {% if delete_album %}checked{% endif %}>
                        <label class="form-check-label" for="delete_album">Delete Album</label>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 fw-bold" style="background: linear-gradient(90deg, #6366f1 0%, #38bdf8 100%); border: none;">Submit</button>
                </form>
            {% endif %}
            {% if job_id %}
                    <label>
                        <span id="progress-label">0%</span>
                    </label>
                    <label>
                        <span id="current-label"></span>
                    </label>
                    <progress id="copy-progress" max="100" value="0"></progress>
                    <div id="copy-errors" class="error-box"></div>
                    <div id="success" class="success-box">Done.</div>
                    <div id="back">
                        <a href="/">Back to start page</a>
                    </div>
            {% endif %}
        </div>
    </body>
</html>
